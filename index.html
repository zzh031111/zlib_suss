<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Library 实时更新网址</title>
    <style>
        /* Basic Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; margin-bottom: 25px; color: #2c3e50; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; margin-top: 30px; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"], input[type="number"], input[type="email"] { /* Added email type */
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
        }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
        button {
            display: block; width: 100%; padding: 12px; background-color: #3498db; color: white; border: none;
            border-radius: 4px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s ease;
            margin-top: 10px; /* Ensure spacing */
        }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* Sections */
        .section { display: none; /* Hide all sections initially */ margin-top: 20px; }
        .section.active { display: block; }

        /* Messages & Alerts */
        .message {
            padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; font-size: 0.95em;
            display: none; /* Hide messages initially */ word-wrap: break-word; /* Wrap long tokens */
        }
        .message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .message.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .message.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .message.visible { display: block; }

        /* URL Display */
        .url-display p { margin-bottom: 10px; font-size: 1.1em; }
        .url-display span { font-weight: bold; color: #e74c3c; }
        .url-display a { color: #3498db; text-decoration: none; }
        .url-display a:hover { text-decoration: underline; }
        .expiry-info { font-size: 0.9em; color: #666; margin-top: 15px; text-align: center; }

        /* Payment Options */
        .payment-options { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .payment-option input[type="radio"] { display: none; }
        .payment-option label {
            cursor: pointer; padding: 10px 20px; border: 1px solid #ccc; border-radius: 5px;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }
        .payment-option input[type="radio"]:checked + label { border-color: #3498db; background-color: #eaf5fc; color: #3498db; }
        .payment-option label img { width: 24px; height: 24px; } /* Add image styling */
        /* Amount Selection */
        .amount-selection { display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .amount-option input[type="radio"] { display: none; }
        .amount-option label {
            cursor: pointer; padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px;
            transition: all 0.3s ease; text-align: center; flex-grow: 1;
        }
        .amount-option input[type="radio"]:checked + label { border-color: #2ecc71; background-color: #e8f8f0; color: #2ecc71; font-weight: bold; }

        /* Access Warning Modal */
        .modal {
            display: none; /* Hidden by default */ position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center; /* Centering */
        }
        .modal-content {
            background-color: #fefefe; margin: auto; /* Removed margin-top */ padding: 25px; border: 1px solid #888;
            width: 90%; max-width: 450px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal-content h2 { margin-top: 0; margin-bottom: 15px; color: #e74c3c; }
        .modal-content p { margin-bottom: 20px; font-size: 1.05em; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
        }
        
        h1, h2 {
            text-align: center;
            color: #4a3aff;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }
        
        .section {
            display: none;
            margin-top: 20px;
        }
        
        #welcome-section {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        button {
            background-color: #4a3aff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3827c0;
        }
        
        .button-group {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        
        .button-group button {
            width: 48%;
        }
        
        .secondary-button {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .secondary-button:hover {
            background-color: #d0d0d0;
        }
        
        .url-display {
            margin-top: 30px;
            padding: 15px;
            background-color: #f0f0ff;
            border-radius: 8px;
            text-align: center;
        }
        
        .url-display a {
            color: #4a3aff;
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }
        
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .error {
            background-color: #fff0f0;
            color: #e74c3c;
        }
        
        .success {
            background-color: #f0fff0;
            color: #27ae60;
        }
        
        .loading {
            text-align: center;
            margin-top: 20px;
        }
        
        .donation-options {
            display: flex;
            justify-content: center;
            gap: 10px; /* Slightly reduce gap for wrapping */
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow items to wrap to the next line */
        }
        
        .donation-option {
            padding: 8px 12px; /* Adjust padding slightly */
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center; /* Center text within the option */
            flex-basis: calc(33.33% - 10px); /* Aim for 3 per row, accounting for gap */
            min-width: 100px; /* Ensure minimum width */
        }
        
        .donation-option .price {
             display: block; /* Make price take its own line */
             font-weight: bold;
             font-size: 1.1em;
        }
        
        .donation-option .duration {
             display: block; /* Make duration take its own line */
             font-size: 0.85em;
             color: #666;
        }

        .donation-option.selected {
            border-color: #4a3aff;
            background-color: #f0f0ff;
        }

        .qrcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px dashed #ddd;
        }
        
        .qrcode-container img {
            max-width: 250px;
            height: auto;
            margin: 10px auto;
            display: block;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .payment-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff8e1;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            line-height: 1.5;
        }

        .donate-notice {
            background-color: #fff8e1;
            border-left: 4px solid #ffab00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            line-height: 1.6;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #999;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        .primary-button {
            background-color: #4a3aff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .primary-button:hover {
            background-color: #3827c0;
        }

        .payment-status-checking {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0ff;
            border-radius: 6px;
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        .access-tip {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* 加深背景蒙层 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px; /* 增加内边距防止内容贴边 */
            box-sizing: border-box; /* 确保padding不影响总宽高 */
        }

        .modal-content {
            background-color: white;
            padding: 25px; /* 增加内容区域内边距 */
            border-radius: 8px;
            max-width: 400px;
            width: 100%; /* 在小屏幕上占满宽度 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center; /* 内容居中 */
        }

        .modal-content h3 {
            margin-top: 0;
            color: #ff4d4f;
        }

        .modal-content .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        .modal-content button {
            width: auto;
            padding: 8px 16px;
            margin: 0 10px;
        }

        button.loading {
            position: relative;
            cursor: not-allowed;
            background-color: #7e75ff; /* 浅一点的颜色 */
        }

        button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .url-display button {
            display: block; /* Make buttons block elements */
            width: 80%; /* Set a consistent width */
            max-width: 250px; /* Optional: max width */
            margin: 10px auto; /* Center the buttons with spacing */
            padding: 12px 20px; /* Ensure consistent padding */
        }

        /* Optional: Style copy button differently */
        .copy-button {
            /* background-color: #e0e0e0; */
            /* color: #333; */
        }

        #payment-polling-status {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
        }

        /* iOS Warning Banner */
        .warning-banner {
            background-color: #fff3cd; /* Light yellow */
            color: #856404; /* Dark yellow text */
            border: 1px solid #ffeeba;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            line-height: 1.5;
            position: relative; /* For positioning the close button */
        }

        .warning-banner .close-warning {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            color: #856404;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        /* End iOS Warning Banner */

        /* Renewal Section Specific Styles (Optional: Reuse existing if identical) */
        #renewal-section {
            /* Similar to #payment-form if needed */
        }
        .renewal-options {
            /* Reuse .donation-options styling if applicable */
            /* display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; */
        }
        .renewal-option {
            /* Reuse .donation-option styling if applicable */
            /* padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; ... */
        }
        /* Style for selected renewal option (if different from donation) */
        /* .renewal-option.selected { border-color: #2ecc71; background-color: #e8f8f0; } */

        /* 新增: 注册/操作成功提示弹窗样式 */
        .modal-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 15px;
            box-sizing: border-box;
        }

        .modal-dialog .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 400px; /* Or adjust as needed */
            animation: fadeIn 0.3s ease-out;
            position: relative;
            /* 移除 transform 实现居中，依赖 flex 布局 */
        }

        .success-dialog .modal-content {
            border-top: 5px solid #4CAF50; /* Green border for success */
        }

        .success-dialog h2 {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.5em;
        }
        .success-dialog p {
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }

        .success-dialog .primary-btn {
            margin-top: 1.5rem;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .success-dialog .primary-btn:hover {
            background-color: #3e8e41;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        /* 结束新增 */
    </style>
</head>
<body>
    <div class="container">
        <h1>ZLibrary 实时链接</h1>
        
        <!-- iOS Warning Banner -->
        <div id="ios-warning" class="warning-banner" style="display: none;">
            <button class="close-warning" title="关闭提示">&times;</button>
            <strong>重要提示：</strong> 苹果手机用户建议使用 <strong>Edge</strong> 或 <strong>Chrome</strong> 浏览器访问本站，以获得最佳体验并避免潜在的注册登录问题。
        </div>
        
        <div class="welcome-message">
            简单注册登录后，即可查看 ZLibrary 实时网址，随时畅游知识海洋！
        </div>
        
        <!-- 站点说明提示 -->
        <div class="info-banner" style="background-color: #E6F7FF; color: #1890FF; border: 1px solid #91D5FF; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-size: 14px; line-height: 1.5;">
            <strong>重要说明：</strong> 本站不是ZLibrary 官方网站，而是<strong> ZLibrary 网址更新服务站。</strong><strong>请勿</strong>使用 ZLibrary 账号登录，请注册新账号使用本站服务！<strong>zibrary网址时常变化，本站提供zlib最新可用网址服务。</strong>
        </div>
        
        <!-- 欢迎部分 -->
        <div id="welcome-section" class="section">
            <div class="button-group">
                <button id="show-login-btn">登录</button>
                <button id="show-register-btn">注册</button>
            </div>
        </div>
        
        <!-- 登录表单 -->
        <div id="login-form" class="section">
            <h2>用户登录</h2>
            <form id="login-form-element" action="javascript:void(0);">
            <div class="form-group">
                    <label for="login-username">用户名</label>
                    <input type="text" id="login-username" required>
            </div>
            <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" required>
            </div>
                <button type="submit">登录</button>
                <div id="login-message" class="message" style="display: none;"></div>
            </form>
            <div class="forgot-password-link" style="text-align: right; margin-top: 10px;">
                <a href="#" id="show-forgot-password-link">忘记密码？</a>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button id="back-to-welcome-from-login" class="secondary-button">返回</button>
            </div>
        </div>

        <!-- 密码重置表单 -->
        <div id="password-reset-form" class="section" style="display: none;">
            <h2>密码重置成功！</h2>

            <!-- 阶段 1: 请求令牌 -->
            <div id="reset-step-1">
                <p>请输入您的用户名以接收密码重置令牌。</p>
            <div class="form-group">
                    <label for="reset-username">用户名</label>
                    <input type="text" id="reset-username" required>
            </div>
                <button id="request-reset-token-btn">请求重置令牌</button>
                <div id="reset-step1-message" class="message" style="display: none;"></div>
            </div>

            <!-- 阶段 2: 重置密码 -->
            <div id="reset-step-2" style="display: none;">
                <p>已向您提供重置令牌（有效期15分钟），请输入令牌和新密码。</p>
                 <div class="form-group">
                    <label for="reset-token">重置令牌</label>
                    <input type="text" id="reset-token" required>
                 </div>
                 <div class="form-group">
                    <label for="reset-new-password">新密码</label>
                    <input type="password" id="reset-new-password" required>
                 </div>
                 <button id="submit-reset-password-btn">重置密码</button>
                 <div id="reset-step2-message" class="message" style="display: none;"></div>
        </div>

            <!-- 阶段 3: 完成 -->
             <div id="reset-step-3" style="display: none;">
                 <p id="reset-final-message"></p>
                 <button id="back-to-login-from-reset">返回登录</button>
             </div>

            <div class="button-group" style="margin-top: 20px;">
                <button id="cancel-reset-btn" class="secondary-button">取消重置</button>
            </div>
        </div>

        <!-- 注册表单 -->
        <div id="register-form" class="section">
            <h2>注册新账号</h2>
            <form id="register-form-element">
            <div class="form-group">
                    <label for="register-username">用户名</label>
                    <input type="text" id="register-username" required>
            </div>
            <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" required minlength="8">
            </div>
            <!-- 新增：小红书订单号输入框 -->
            <div class="form-group">
                <label for="register-xhs-order-id">小红书订单号:</label>
                <input type="text" id="register-xhs-order-id" required placeholder="请输入您的小红书购买订单号">
            </div>
            <!-- 结束新增 -->
            <div id="register-message" class="message"></div>
            <button id="submit-register-btn">注册</button>
            <button id="back-to-welcome-from-register" class="secondary-button">返回</button>
        </div>

        <!-- 用户主页 -->
        <div id="user-dashboard" class="section">
            <h2>欢迎回来</h2>
            <div id="user-greeting">正在加载用户信息...</div>
            
            <!-- 账号有效期信息 -->
            <div id="account-info" class="account-info-box" style="margin-top: 15px; background-color: #f0f8ff; border-left: 4px solid #1890ff; padding: 10px; border-radius: 4px;">
                <!-- 移除有效期信息 -->
                <!-- <div><strong>账号有效期：</strong><span id="account-expiry">正在获取...</span></div> -->
                <!-- 保留或修改说明 -->
                <div style="font-size: 13px; color: #666; margin-top: 5px;">注：本站账号永久有效。</div>
            </div>
            
            <div class="url-display">
                <h3>ZLibrary 最新链接</h3>
                <div class="access-tip">进入zlibrary后，建议登录自有账号或者注册新账号，不受IP下载限制，体验更佳！</div>
                <div class="access-tip" style="background-color: #FFF7E6; border-left: 4px solid #FFBB96; color: #D46B08;">
                    <strong>访问提示：</strong>如进入链接失败，请尝试备用链接或更换 <strong>Edge</strong> 或 <strong>Chrome</strong> 浏览器访问。
                </div>
                <div id="current-url">正在获取最新链接，请稍候...</div>
                <!-- Buttons will be dynamically controlled -->
                <button id="copy-zlib-url" class="copy-button primary-button" style="display: none;">复制</button>
                <button id="jump-to-zlib" class="primary-button" style="display: none;">前往访问</button>
            </div>
            
            <!-- Add Renewal Button -->
            <button id="logout-btn" style="margin-top: 30px;">退出登录</button>
        </div>

        <!-- NEW: Renewal Section -->
        <div id="renewal-section" class="section">
            <h2>选择续费套餐</h2>
            <div id="renewal-message" class="message" style="display: none;"></div>

            <!-- Renewal Options Container -->
            <div class="form-group">
                <label>续费时长</label>
                <!-- Price loading message for renewal -->
                <div id="renewal-price-loading-message" class="message info" style="display: none;">正在加载价格...</div>
                <div class="renewal-options donation-options" style="display: none;">
                    <!-- Options will be populated by JavaScript -->
                    <!-- Example structure (will be generated dynamically): -->
                    <!--
                    <div class="donation-option renewal-option" data-option-key="monthly" data-amount="3.99">
                        <span class="price">￥3.99</span> / 月
                        <span class="duration">(31天)</span>
                    </div>
                    -->
                </div>
            </div>

            <div id="renewal-process-message" class="message" style="display: none;"></div>

            <!-- Renewal Buttons -->
            <div class="button-group">
                <button id="confirm-renewal-btn">确认续费</button>
                <button id="cancel-renewal-btn" class="secondary-button">取消</button>
            </div>
        </div>
        <!-- END Renewal Section -->

        <!-- 移除支付轮询状态 -->
        <!-- <div id="payment-polling-status" style="display: none;"> ... </div> -->

        <div class="footer">
            &copy; 2025 ZLibrary 链接更新服务 | 本站仅提供链接更新服务，不存储任何内容
        </div>
    </div>

    <div id="warn-dialog" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>访问提示</h3>
            <p>该网站疑似存在盗版资源，请自行甄别，维护正版！</p>
            <div class="button-group">
                <button id="confirm-jump" class="primary-button">确认访问</button>
                <button id="cancel-jump" class="secondary-button">取消</button>
            </div>
        </div>
    </div>

    <script>
        // --- 新增: 后端API基础URL配置 ---
        // !!! 重要: 请将这里替换为你的实际云函数触发器的URL !!!
        const BACKEND_BASE_URL = 'https://yhss.kaxsx.top/zlib1'; // 示例URL，请务必修改
        // ---
        
        // --- State Variables (Global Scope) ---
        const JWT_TOKEN_KEY = 'zlib_jwt_token'; // 使用常量避免拼写错误
        // --- 移除支付和任务轮询相关变量 ---
        // let paymentPollInterval = null; 
        // let pollAttempts = 0;
        // const maxPollAttempts = 60; 
        // const PAYMENT_POLL_INTERVAL_MS = 5000; 
        // let taskPollInterval = null;
        // let taskPollTimeoutId = null;
        // let currentTaskTradeNo = null; 
        // const TASK_POLL_INTERVAL_MS = 3000; 
        // const TASK_POLL_TIMEOUT_MS = 60000; 
        // 移除价格变量
        // let loadedPrices = {};

        let resetUsername = ''; // 用于在密码重置步骤间暂存用户名

        // 临时存储注册信息 (如果需要跨步骤传递) - 现在直接在注册函数处理
        // let tempRegisterData = { username: '', password: '' };

        // --- 移除不再需要的轮询和支付处理函数定义 --- 
        // function stopPaymentPolling(reason) { ... }
        // async function checkPaymentStatusPoll(outTradeNo, username) { ... }
        // function startPaymentPolling(outTradeNo, username) { ... }
        // async function handleRegisterStep2() { ... } // 旧的支付步骤处理函数
        // function clearPaymentArea(...) { ... }
        // function startPaymentTaskPolling(...) { ... }
        // async function checkPaymentTaskStatus(...) { ... }
        // function stopPaymentTaskPolling(reason) { ... }
        // function handlePaymentInfo(...) { ... }
        // async function loadAndDisplayPrices() { ... }
        // function updatePriceOptionsUI(...) { ... }
        // function populatePriceOptionsUI(...) { ... }
        // function loadAndDisplayRenewalPrices(...) { ... }
        // async function handleConfirmRenewal() { ... }
        // function stopRenewalTaskPolling(reason) { ... }
        // function checkPendingPaymentOnLoad(currentUsername) { ... }
        // --- 结束移除 --- 

        // --- Helper Functions (保留 showMessage, setButtonLoading, showSection, logout) ---

        // 显示信息通用函数
        function showMessage(element, text, isError = false, isSuccess = false) {
            if (!element) {
                console.warn("Attempted to show message on a null element.");
                return;
            }
            element.textContent = text;
            element.className = 'message'; // Reset classes first
            if (isError) {
                element.classList.add('error', 'visible');
            } else if (isSuccess) {
                 element.classList.add('success', 'visible');
             } else {
                element.classList.add('info', 'visible'); // Default to info
            }
             element.style.display = 'block'; // Ensure visibility
        }

        // 设置按钮加载状态
        function setButtonLoading(button, isLoading, loadingText = '处理中...') {
            if (!button) {
                 console.warn("Attempted to set loading state on a null button.");
                 return;
            }
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent; // Store original text
                // 使用简单的文本或添加 spinner (确保 CSS 支持 .loading-spinner)
                 button.innerHTML = `<span class="loading-spinner" style="display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 5px; vertical-align: middle;"></span> ${loadingText}`;
                 button.classList.add('loading'); // Add class for potential spinner styling
                 // -- 移除动态 CSS 检查和插入 --
                 // if (!document.styleSheets[0].cssRules.namedItem('spin')) {
                 //     document.styleSheets[0].insertRule(`@keyframes spin { to { transform: rotate(360deg); } }`, document.styleSheets[0].cssRules.length);
                 // }
            } else {
                button.disabled = false;
                // Restore original text if it was stored
                button.textContent = button.dataset.originalText || 'Submit'; // Provide a default fallback
                button.classList.remove('loading');
                // Clean up dataset attribute
                delete button.dataset.originalText;
            }
        }

        // 切换显示区域
        function showSection(sectionId) {
            console.log(`【UI】Attempting to show section: ${sectionId}`);
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = section.id === sectionId ? 'block' : 'none';
            });
             // 特殊处理：确保注册和支付表单互斥
             const registerSection = document.getElementById('register-form');
             const paymentSection = document.getElementById('payment-form');
             if (registerSection && paymentSection) {
                  if (sectionId === 'register-form') {
                     paymentSection.style.display = 'none';
                 } else if (sectionId === 'payment-form') {
                     registerSection.style.display = 'none';
                 }
             }

             // 隐藏续费区域，除非明确显示它
             const renewalSection = document.getElementById('renewal-section');
              if (renewalSection && sectionId !== 'renewal-section') {
                 renewalSection.style.display = 'none';
             }

             // 控制"立即续费"按钮的可见性
             const showRenewalBtn = document.getElementById('show-renewal-btn');
             const token = localStorage.getItem(JWT_TOKEN_KEY);
             const userDashboardVisible = document.getElementById('user-dashboard')?.style.display === 'block';
             const renewalSectionVisible = renewalSection?.style.display === 'block';

              if (showRenewalBtn) {
                 if (token && userDashboardVisible && !renewalSectionVisible) {
                     showRenewalBtn.style.display = 'inline-block'; // 登录、在仪表盘、续费区隐藏时显示
                 } else {
                      showRenewalBtn.style.display = 'none'; // 其他情况隐藏
                 }
              }

             // 停止所有轮询当切换区域时 (除特定情况，如支付成功自动跳到仪表盘)
             // 简化：切换到非 dashboard 或非支付/续费 区域时停止轮询
             // --- 移除所有 stop...Polling 调用 --- 
             // if (!['user-dashboard', 'payment-form', 'renewal-section'].includes(sectionId)) {
             //     console.log(`【POLL】Stopping polls due to section change to: ${sectionId}`);
             //     stopPaymentTaskPolling('用户切换区域');
             //     stopPaymentPolling('用户切换区域');
             //     stopRenewalTaskPolling('用户切换区域');
             // }
            console.log(`【UI】Displayed section: ${sectionId}`);
        }

        // 退出登录
        function logout() {
            console.log("【AUTH】Logging out...");
            localStorage.removeItem(JWT_TOKEN_KEY);
            localStorage.removeItem('zlibUsername');
            localStorage.removeItem('pendingZlibPayment'); // 清除待处理支付信息
            // --- 移除 stop...Polling 调用 --- 
            // stopPaymentPolling('用户登出');
            // stopPaymentTaskPolling('用户登出');
            // stopRenewalTaskPolling('用户登出');
            showSection('welcome-section'); // 显示欢迎界面

            // 清理用户特定的 UI 元素
            const userGreeting = document.getElementById('user-greeting');
            // --- 移除 accountInfo 获取和清理 --- 
            // const accountInfo = document.getElementById('account-info'); 
            const currentUrl = document.getElementById('current-url');
            const copyBtn = document.getElementById('copy-zlib-url');
            const jumpBtn = document.getElementById('jump-to-zlib');
            // --- 移除 showRenewalBtn 获取和清理 --- 
            // const showRenewalBtn = document.getElementById('show-renewal-btn'); 

            if(userGreeting) userGreeting.textContent = '正在加载用户信息...';
            // if(accountInfo) accountInfo.style.display = 'none'; // 移除对 accountInfo 的引用
            if(currentUrl) currentUrl.innerHTML = '正在获取最新链接，请稍候...';
            if(copyBtn) copyBtn.style.display = 'none';
            if(jumpBtn) jumpBtn.style.display = 'none';
            // if (showRenewalBtn) showRenewalBtn.style.display = 'none'; // 移除

            console.log("【AUTH】User logged out successfully.");
        }

        // 检查用户状态 (修改：移除 accountInfo 引用)
        async function checkUserStatus(source = 'auto') { 
            const token = localStorage.getItem(JWT_TOKEN_KEY);
            console.log(`【STATUS】checkUserStatus called (Source: ${source}).`);

            const userGreeting = document.getElementById('user-greeting');
            const copyBtn = document.getElementById('copy-zlib-url');
            const jumpBtn = document.getElementById('jump-to-zlib');
            const currentUrlDiv = document.getElementById('current-url');

            if (source === 'registration_success' && userGreeting) {
                showMessage(userGreeting, '注册成功！欢迎您。账户信息已加载。', false, true);
                showSection('user-dashboard');
            }

            if (token) {
                console.log("【STATUS】Token found. Preparing to fetch status...");
                try {
                    console.log("【STATUS】Fetching from /api/get_current_url...");
                    const response = await fetch(`${BACKEND_BASE_URL}/api/get_current_url`, { 
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    console.log(`【STATUS】Fetch response received. Status: ${response.status}, OK: ${response.ok}`);

                    let data;
                    try {
                        data = await response.json(); 
                        console.log("【STATUS】Response JSON parsed successfully:", data);
                    } catch (parseError) {
                        console.error("【STATUS】Error parsing JSON response:", parseError);
                        let textResponse = '';
                        try {
                             textResponse = await response.text();
                             console.error("【STATUS】Raw response text:", textResponse);
                         } catch (textError) {
                             console.error("【STATUS】Could not read response text:", textError);
                         }
                        throw new Error(`无法解析服务器响应 (${parseError.message})`);
                    } 

                    if (response.ok) {
                        console.log("【STATUS】Response OK. Processing successful data...");
                        const username = data.username || localStorage.getItem('zlibUsername') || '用户';
                        localStorage.setItem('zlibUsername', username);

                        console.log(`【STATUS UI】Updating dashboard for user: ${username}`);
                        if (userGreeting) {
                            if (source !== 'registration_success') { 
                                userGreeting.textContent = `欢迎您，${username}！`;
                            }
                            userGreeting.style.display = 'block';
                            console.log(`【STATUS UI】Set/Ensured userGreeting text`);
                        } else { console.error("【STATUS UI】Element not found: user-greeting"); }
                        
                        // --- 移除所有对 accountInfo 的引用 --- 
                        // if (accountInfo) { accountInfo.style.display = 'block'; console.log("【STATUS UI】Made accountInfo visible."); } else { console.error("【STATUS UI】Element not found: account-info"); }

                        if (currentUrlDiv) {
                            // ... (URL 显示逻辑保持不变)
                            if (data.primary_url) {
                                currentUrlDiv.innerHTML = `
                                   <p><strong>主线路:</strong> <a href="#" data-url="${data.primary_url}" class="zlib-link">${data.primary_url}</a></p>
                                   ${data.backup_url ? `<p><strong>备用线路:</strong> <a href="#" data-url="${data.backup_url}" class="zlib-link">${data.backup_url}</a></p>` : ''}
                                `;
                                console.log("【STATUS UI】Updated currentUrlDiv HTML.");

                                if (copyBtn) {
                                    copyBtn.style.display = 'inline-block';
                                    copyBtn.onclick = () => copyUrlToClipboard(data.primary_url);
                                    console.log("【STATUS UI】Copy button made visible and handler set.");
                                } else { console.error("【STATUS UI】Element not found: copy-zlib-url"); }

                                if (jumpBtn) {
                                    jumpBtn.style.display = 'inline-block';
                                    jumpBtn.onclick = () => showWarnDialog(data.primary_url);
                                    console.log("【STATUS UI】Jump button made visible and handler set.");
                                } else { console.error("【STATUS UI】Element not found: jump-to-zlib"); }

                                document.querySelectorAll('.zlib-link').forEach(link => {
                                    link.onclick = (e) => {
                                        e.preventDefault();
                                        showWarnDialog(link.getAttribute('data-url'));
                                    };
                                });
                                console.log("【STATUS UI】Link listeners attached.");

                            } else {
                                currentUrlDiv.innerHTML = '<p style="color: red;">无法获取有效链接...</p>';
                                console.log("【STATUS UI】Set currentUrlDiv to error message.");
                                if (copyBtn) copyBtn.style.display = 'none';
                                if (jumpBtn) jumpBtn.style.display = 'none';
                            }
                        } else { console.error("【STATUS UI】Element not found: current-url"); }
                        
                        showSection('user-dashboard');
                        console.log("【STATUS】Ensured user-dashboard section is visible.");

                    } else {
                        console.warn(`【STATUS】Response not OK (${response.status}). Handling error...`);
                        if (response.status === 401) {
                            console.warn("【STATUS】Handling 401 Unauthorized.");
                            showMessage(document.getElementById('login-message') || document.body, '登录凭证无效或已过期，请重新登录。', true);
                            logout();
                        } else {
                            console.error(`【STATUS】Handling other error status: ${response.status}`);
                            showMessage(document.getElementById('user-greeting') || document.body, `获取用户信息时出错 (${response.status}): ${data.message || '请稍后重试'}`, true);
                            // 发生其他错误时，不再强制登出，而是留在 Dashboard 显示错误
                            showSection('user-dashboard');
                        }
                    }
                } catch (error) { 
                    console.error('【STATUS】Error during checkUserStatus fetch/processing:', error);
                    showMessage(document.getElementById('user-greeting') || document.body, `检查用户状态时发生错误: ${error.message}`, true);
                    logout(); // 捕获到 JS 错误 (如此处修复的 accountInfo 错误) 或网络错误时，执行登出
                } 
            } else {
                console.log("【STATUS】No token found. Showing welcome section.");
                showSection('welcome-section');
            }
            console.log("【STATUS】checkUserStatus finished.");
        }

        // --- 注册流程 ---
        async function handleRegisterStep1(username, password) {
            const registerMessage = document.getElementById('register-message');
            const registerButton = document.getElementById('submit-register-btn');
            console.log(`【REGISTER】Step 1: Validating input for user: ${username}`);
            
            // --- 移除后端 /api/register 调用 --- 
            // 直接进行本地验证和界面切换
            
            // 可选：在这里可以添加更复杂的本地验证逻辑
            
            console.log("【REGISTER】Step 1 successful (Input validated). Proceeding to payment form.");
            tempRegisterData = { username, password }; // 存储临时数据
            // 可选：在注册表单短暂显示成功消息，然后切换
            // showMessage(registerMessage, '请完成捐赠以激活账号。', false, true); 
            // setTimeout(() => { ... }, 500); // 延迟切换

            // 直接显示支付表单，并预填用户名
            showSection('payment-form');
            const paymentUsernameDisplay = document.getElementById('payment-username-display');
            if (paymentUsernameDisplay) paymentUsernameDisplay.textContent = `用户名: ${username}`;
            
            // 确保支付按钮可用
            const payButton = document.getElementById('pay-btn');
            if(payButton) setButtonLoading(payButton, false);
            
            // 清理支付区域可能残留的状态
            clearPaymentArea();
            // 清理注册消息
            if(registerMessage) registerMessage.style.display = 'none'; 

            // 恢复注册按钮状态 (虽然立刻切换了，但以防万一)
            if(registerButton) setButtonLoading(registerButton, false); 
        }

        // 处理 \"立即捐赠\" 按钮点击 (注册流程)
        // --- 修改：改为异步处理流程 --- 
        async function handleRegisterStep2() {
            const selectedOption = document.querySelector('#payment-form .donation-option.selected');
            const paymentProcessMessage = document.getElementById('payment-process-message'); // 注册的消息区
            const payButton = document.getElementById('pay-btn'); // 注册的支付按钮

            if (!selectedOption) {
                showMessage(paymentProcessMessage, '请选择一个捐赠选项。', true);
                return;
            }

            const amount = selectedOption.getAttribute('data-amount');
            const optionKey = selectedOption.getAttribute('data-option-key'); // 获取选项标识
            const username = tempRegisterData.username; // 从临时存储获取用户名
            const password = tempRegisterData.password; // 从临时存储获取密码

            if (!username || !password) {
                showMessage(paymentProcessMessage, '无法获取注册信息，请返回注册步骤重试。', true);
                showSection('register-form'); // Guide user back
                return;
            }
            if (!amount || !optionKey) {
                 showMessage(paymentProcessMessage, '选择的捐赠选项无效或未加载价格。', true);
                 return;
            }

            console.log(`【REGISTER】Step 2: Creating payment request for user: ${username}, amount: ${amount}, option: ${optionKey}`);
            setButtonLoading(payButton, true, '创建订单...');
            showMessage(paymentProcessMessage, '正在创建捐赠订单，请稍候...', false);
            clearPaymentArea(); // 清理旧的二维码和信息

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/create_payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 发送注册所需的所有信息
                    body: JSON.stringify({
                        username: username,
                        password: password, // 发送密码用于首次hash
                        amount: amount,
                        option_key: optionKey // 发送选项key
                    })
                });

                if (response.status === 202) { // 异步任务已接受
                    const data = await response.json();
                     if (data.status === 'processing' && data.out_trade_no) {
                         console.log(`【REGISTER ASYNC】Backend accepted task, Order ID: ${data.out_trade_no}`);
                         showMessage(paymentProcessMessage, '捐赠订单创建中，请稍候...', false);
                         // 启动异步任务状态轮询
                         startPaymentTaskPolling(
                             data.out_trade_no,
                             paymentProcessMessage, // 注册的消息区
                             username, // 传递用户名给后续处理
                             payButton, // 注册的支付按钮
                             '#payment-form .qrcode-container', // 注册的二维码容器选择器
                             '#payment-form .payment-info',    // 注册的支付信息选择器
                             '#payment-form #redirect-to-pay' // 注册的跳转按钮选择器
                         );
                     } else {
                         throw new Error('后端响应格式不正确 (status: processing, out_trade_no)。');
                     }

                } else if (response.ok) { // 可能是同步成功？(兼容一下)
                     const data = await response.json();
                     console.warn("【REGISTER SYNC】Backend returned success directly (non-async):", data);
                     stopPaymentTaskPolling('收到同步成功响应'); // 停止可能已启动的任务轮询
                     // setButtonLoading(payButton, false); // handlePaymentInfo会处理按钮状态
                     if (data.out_trade_no && (data.payurl || data.img || data.pay_url || data.qr_code_url)) { // 检查支付信息
                          console.log("【REGISTER SYNC】Processing payment info...");
                          handlePaymentInfo(
                              data,
                              paymentProcessMessage,
                              username,
                              payButton,
                             '#payment-form .qrcode-container',
                             '#payment-form .payment-info',
                             '#payment-form #redirect-to-pay'
                          );
                     } else {
                          throw new Error('注册成功响应缺少必要的支付信息 (out_trade_no, pay_url/qr_code_url)。');
                     }

                 } else { // 处理错误响应
                    const errorData = await response.json().catch(() => ({ message: '无法解析错误信息' }));
                    throw new Error(errorData.message || `创建支付请求失败 (${response.status})`);
                }

            } catch (error) {
                console.error('【REGISTER】Error during step 2 (create payment):', error);
                showMessage(paymentProcessMessage, `创建订单失败: ${error.message}`, true);
                setButtonLoading(payButton, false);
                stopPaymentTaskPolling('创建支付请求出错'); // 停止任务轮询
            }
        }

        // --- 异步任务状态轮询 --- (/api/check_payment_task_status)
        function startPaymentTaskPolling(outTradeNo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector) {
             stopPaymentTaskPolling('启动新的任务轮询'); // 先停止之前的轮询
             stopPaymentPolling('启动任务轮询，停止支付状态轮询'); // 确保支付状态轮询也停了

             console.log(`【TASK POLL】Starting task status poll - Order ID: ${outTradeNo}`);
             if (messageAreaElement) showMessage(messageAreaElement, '订单创建中，请稍候...', false);
             if (triggerButton) setButtonLoading(triggerButton, true, '处理中...'); // 禁用触发按钮

             currentTaskTradeNo = outTradeNo; // 存储当前订单号
             let startTime = Date.now();

             // 设置超时
             taskPollTimeoutId = setTimeout(() => {
                 console.error(`【TASK POLL】Task polling timed out - Order ID: ${outTradeNo}`);
                 stopPaymentTaskPolling('任务轮询超时');
                 if (messageAreaElement) showMessage(messageAreaElement, '订单创建超时，请刷新页面或联系客服。', true);
                 if (triggerButton) setButtonLoading(triggerButton, false); // 超时后启用按钮
             }, TASK_POLL_TIMEOUT_MS);

             // 立即执行一次检查，然后设置间隔
             checkPaymentTaskStatus(outTradeNo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector);
             taskPollInterval = setInterval(() => {
                 checkPaymentTaskStatus(outTradeNo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector);
             }, TASK_POLL_INTERVAL_MS);
        }

        async function checkPaymentTaskStatus(outTradeNo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector) {
             // 如果全局存储的当前任务号变了，说明开始了新的任务，停止这个旧的轮询
             if (currentTaskTradeNo !== outTradeNo) {
                  console.warn(`【TASK POLL】Current task changed to ${currentTaskTradeNo}. Stopping poll for old task ${outTradeNo}.`);
                  // Silently stop this interval without user message
                  clearInterval(taskPollInterval);
                  clearTimeout(taskPollTimeoutId); // Also clear its timeout
                  return;
             }
              console.log(`【TASK POLL】Checking task status - Order ID: ${outTradeNo}`);

             try {
                 const response = await fetch(`${BACKEND_BASE_URL}/api/check_payment_task_status`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ out_trade_no: outTradeNo })
                 });

                 const result = await response.json(); // Try to parse JSON even for non-OK responses

                 if (!response.ok) {
                     console.error(`【TASK POLL】Task status check failed (${response.status}) for ${outTradeNo}. Response:`, result);
                     stopPaymentTaskPolling(`任务状态检查失败 (${response.status})`);
                     if (messageAreaElement) showMessage(messageAreaElement, `查询订单创建状态失败: ${result.message || '未知错误'}`, true);
                     if (triggerButton) setButtonLoading(triggerButton, false);
                     return; // Stop polling on definite error
                 }

                 console.log(`【TASK POLL】Task status response for ${outTradeNo}:`, result);

                 if (result.status === 'success') {
                     console.log(`【TASK POLL】Task succeeded - Order ID: ${outTradeNo}`);
                     stopPaymentTaskPolling('任务成功完成'); // Stop this task polling
                     const paymentInfo = result.payment_info;

                     if (paymentInfo && paymentInfo.out_trade_no) {
                         // --- Process the payment info (show QR/redirect, start payment polling) ---
                         handlePaymentInfo(paymentInfo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector);
                     } else {
                          console.error("【TASK POLL】Task succeeded, but response lacked valid payment_info:", paymentInfo);
                          if(messageAreaElement) showMessage(messageAreaElement, '订单创建成功，但支付信息不完整。', true);
                          if (triggerButton) setButtonLoading(triggerButton, false); // Re-enable button
                     }

                 } else if (result.status === 'failed') {
                     console.error(`【TASK POLL】Task failed - Order ID: ${outTradeNo}, Reason: ${result.message}`);
                     stopPaymentTaskPolling('任务执行失败');
                     if(messageAreaElement) {
                        showMessage(messageAreaElement, `订单创建失败: ${result.message || '未知错误'}`, true);
                     }
                     if (triggerButton) setButtonLoading(triggerButton, false); // Re-enable button

                 } else if (result.status === 'pending') {
                     console.log(`【TASK POLL】Task still pending - Order ID: ${outTradeNo}`);
                     if (messageAreaElement) showMessage(messageAreaElement, '订单创建中，请稍候...', false); // Update pending message
                 } else {
                     console.warn(`【TASK POLL】Received unknown task status: ${result.status} for ${outTradeNo}`);
                     // Decide whether to continue polling or stop with error
                     // stopPaymentTaskPolling('未知任务状态');
                     // showMessage(messageAreaElement, '收到未知的订单状态，请稍后重试。', true);
                     // if (triggerButton) setButtonLoading(triggerButton, false);
                 }

             } catch (error) {
                 console.error(`【TASK POLL】Network or parsing error during checkPaymentTaskStatus for ${outTradeNo}:`, error);
                 // Optional: Implement retry logic or stop polling after several errors
                 // stopPaymentTaskPolling('查询任务状态时出错');
                 // showMessage(messageAreaElement, '查询订单状态时发生网络错误。', true);
                 // if (triggerButton) setButtonLoading(triggerButton, false);
             }
         }

         function stopPaymentTaskPolling(reason) {
             console.log(`【TASK POLL】Stopping task poll, Reason: ${reason}`);
             if (taskPollInterval) {
                 clearInterval(taskPollInterval);
                 taskPollInterval = null;
             }
             if (taskPollTimeoutId) {
                 clearTimeout(taskPollTimeoutId);
                 taskPollTimeoutId = null;
             }
             // Only clear currentTaskTradeNo if the reason isn't about being outdated
             if (reason.indexOf('已过时') === -1) {
                 currentTaskTradeNo = null;
             }
             // Button state is handled within checkPaymentTaskStatus based on outcome
         }

        // --- 处理支付信息并更新UI ---
        function handlePaymentInfo(paymentInfo, messageAreaElement, username, triggerButton, qrContainerSelector, paymentInfoSelector, redirectButtonSelector) {
            // --- 修改：使用后端实际返回的字段名 --- 
            const payUrl = paymentInfo.payurl || paymentInfo.pay_url; // 兼容 payurl 和 pay_url
            const qrCodeUrl = paymentInfo.img || paymentInfo.qr_code_url; // 兼容 img 和 qr_code_url
            // --- 结束修改 ---
            const outTradeNo = paymentInfo.out_trade_no;

            console.log(`【PAYMENT UI】Handling payment info for Order ID: ${outTradeNo}`, paymentInfo);

            // --- 存储注册状态逻辑保持不变 ---
            const isRegistrationFlow = triggerButton && triggerButton.id === 'pay-btn';
            if (isRegistrationFlow) {
                 try {
                     const selectedOption = document.querySelector('#payment-form .donation-option.selected');
                     const registrationState = {
                          out_trade_no: outTradeNo,
                          username: username,
                          option_key: selectedOption?.getAttribute('data-option-key'), // Store selected option
                          amount: selectedOption?.getAttribute('data-amount')       // Store selected amount
                     };
                     localStorage.setItem('pendingRegistrationPayment', JSON.stringify(registrationState));
                     console.log("【REGISTER STATE】Stored pending registration state in localStorage.", registrationState);
                 } catch (e) {
                     console.error("【REGISTER STATE】Failed to store pending registration state:", e);
                 }
             }
             // --- 结束新增 ---

            // Hide processing message
            if (messageAreaElement) messageAreaElement.style.display = 'none';

            // --- IMPORTANT: Start polling for actual payment status (check /api/check_payment) ---
            startPaymentPolling(outTradeNo, username); // 轮询总是在原始页面启动

            // --- 修改: 统一显示二维码和新标签页按钮（如果可用）---
            if (qrCodeUrl) { 
                console.log("【PAYMENT UI】Displaying QR code and/or New Tab button.");
                const qrContainer = document.querySelector(qrContainerSelector);
                const qrcodeImage = qrContainer ? qrContainer.querySelector('img') : null;
                const paymentInfoElem = document.querySelector(paymentInfoSelector);
                const redirectButton = document.querySelector(redirectButtonSelector);

                if (qrContainer && qrcodeImage) {
                    qrcodeImage.src = qrCodeUrl;
                    qrContainer.style.display = 'block';

                    if (paymentInfoElem) {
                        const amount = paymentInfo.amount || document.querySelector(`${qrContainerSelector.split(' ')[0]} .selected`)?.getAttribute('data-amount') || 'N/A';
                        // 更新提示信息
                        paymentInfoElem.textContent = `请扫描上方二维码，或点击下方按钮在新标签页中完成 ${amount} 元支付。订单号: ${outTradeNo}，10分钟内有效。支付完成后请返回此页面。`;
                        paymentInfoElem.style.display = 'block';
                    } else { /* ... */ }

                    // 提供新标签页打开按钮 (如果 payUrl 存在)
                    if (redirectButton && payUrl) {
                        redirectButton.textContent = '在新标签页打开支付';
                        redirectButton.style.display = 'inline-block';
                        redirectButton.onclick = () => { 
                            console.log("【PAYMENT UI】Opening payment URL in new tab:", payUrl);
                            window.open(payUrl, '_blank'); 
                        };
                    } else if (redirectButton) {
                        redirectButton.style.display = 'none';
                    } else { /* ... */ }

                    if(triggerButton) {
                       setButtonLoading(triggerButton, true, '待支付');
                    }

                    const pollingStatusDiv = document.getElementById('payment-polling-status');
                    if (pollingStatusDiv) {
                        pollingStatusDiv.innerHTML = `<p class=\"pulse\">正在查询支付状态，请在扫码或新标签页支付后返回此页...</p>`;
                        pollingStatusDiv.style.display = 'block';
                    } else { /* ... */ }

                } else {
                    // 处理无法显示二维码的情况
                    console.error(`【PAYMENT UI】Cannot find QR code elements: Container="${qrContainerSelector}", Image=${qrcodeImage}`);
                    if (payUrl) { // 如果有支付链接，至少提供按钮
                         console.log("【PAYMENT UI】QR failed, but payUrl exists. Providing New Tab button.");
                         const redirectButton = document.querySelector(redirectButtonSelector);
                         if (redirectButton) {
                              redirectButton.textContent = '在新标签页打开支付';
                              redirectButton.style.display = 'inline-block';
                              redirectButton.onclick = () => { window.open(payUrl, '_blank'); };
                              if(triggerButton) setButtonLoading(triggerButton, true, '待支付');
                              const pollingStatusDiv = document.getElementById('payment-polling-status');
                               if (pollingStatusDiv) {
                                    pollingStatusDiv.innerHTML = `<p class=\"pulse\">无法显示二维码。正在查询支付状态，请在新标签页支付后返回此页...</p>`; // 更新提示
                                    pollingStatusDiv.style.display = 'block';
                               } 
                         } else { /* ... 处理按钮丢失错误 ... */ }
                    } else { // 二维码和链接都没有
                         if(messageAreaElement) showMessage(messageAreaElement, '订单创建成功，但无法显示二维码或支付链接。', true);
                         if (triggerButton) setButtonLoading(triggerButton, false);
                    }
                }
            } else if (payUrl) { // 只有 payUrl，没有 qrCodeUrl
                 console.log("【PAYMENT UI】Only payUrl available. Providing New Tab button.");
                 const redirectButton = document.querySelector(redirectButtonSelector);
                 const paymentInfoElem = document.querySelector(paymentInfoSelector); // 也尝试更新提示
                 
                 if (paymentInfoElem) {
                      const amount = paymentInfo.amount || document.querySelector(`${qrContainerSelector.split(' ')[0]} .selected`)?.getAttribute('data-amount') || 'N/A';
                      paymentInfoElem.textContent = `请点击下方按钮在新标签页中打开支付页面完成 ${amount} 元支付。订单号: ${outTradeNo}，10分钟内有效。支付完成后请返回此页面。`;
                      paymentInfoElem.style.display = 'block';
                 } else { /* ... */ }

                 if (redirectButton) {
                      redirectButton.textContent = '在新标签页打开支付';
                      redirectButton.style.display = 'inline-block';
                      redirectButton.onclick = () => { window.open(payUrl, '_blank'); };
                       if(triggerButton) setButtonLoading(triggerButton, true, '待支付');
                       const pollingStatusDiv = document.getElementById('payment-polling-status');
                        if (pollingStatusDiv) {
                             pollingStatusDiv.innerHTML = `<p class=\"pulse\">正在查询支付状态，请在新标签页支付后返回此页...</p>`;
                             pollingStatusDiv.style.display = 'block';
                        } 
                 } else {
                      console.error(`【PAYMENT UI】Redirect button not found: "${redirectButtonSelector}"`);
                      if(messageAreaElement) showMessage(messageAreaElement, '订单创建成功，但缺少必要按钮无法打开支付。', true);
                      if (triggerButton) setButtonLoading(triggerButton, false);
                 }
            } else {
                console.error("【PAYMENT UI】Payment info lacks both QR code URL and payment URL.");
                if(messageAreaElement) showMessage(messageAreaElement, '订单创建成功，但缺少支付信息，请联系客服。', true);
                if (triggerButton) setButtonLoading(triggerButton, false);
            }
         }

        // --- 续费流程 ---
        // loadAndDisplayRenewalPrices is called when showing renewal section if prices are loaded
        function loadAndDisplayRenewalPrices(pricesData) {
             const renewalOptionsContainer = document.querySelector('#renewal-section .renewal-options');
             const renewalLoadingMsg = document.getElementById('renewal-price-loading-message');

             console.log("【RENEWAL PRICE】Loading renewal prices into UI...");

             if (!renewalOptionsContainer) {
                 console.error("【RENEWAL PRICE】Renewal options container not found.");
                 if(renewalLoadingMsg) showMessage(renewalLoadingMsg, 'UI错误：找不到续费选项容器。', true);
                 return;
             }
             if (!pricesData || Object.keys(pricesData).length === 0) {
                 console.error("【RENEWAL PRICE】No valid prices data provided.");
                 if (renewalLoadingMsg) showMessage(renewalLoadingMsg, '无法加载续费选项价格。', true);
                 renewalOptionsContainer.style.display = 'none';
                 return;
             }

             // Update renewal UI using the common function
             updatePriceOptionsUI('#renewal-section .renewal-option', pricesData, renewalLoadingMsg, renewalOptionsContainer);
        }

        async function handleConfirmRenewal() {
            const confirmButton = document.getElementById('confirm-renewal-btn');
            const processMessageArea = document.getElementById('renewal-process-message');
            const selectedOption = document.querySelector('#renewal-section .renewal-option.selected');
            const token = localStorage.getItem(JWT_TOKEN_KEY);
            const username = localStorage.getItem('zlibUsername'); // Get username

            if (!token || !username) {
                showMessage(processMessageArea || document.body, '用户未登录或信息丢失，请重新登录。', true);
                logout(); // Force logout if essential info is missing
                return;
            }
            if (!selectedOption) {
                showMessage(processMessageArea, '请选择一个续费选项。', true);
                return;
            }

            const amount = selectedOption.getAttribute('data-amount');
            const optionKey = selectedOption.getAttribute('data-option-key');

            if (!amount || !optionKey) {
                 showMessage(processMessageArea, '选择的选项无效或价格未加载。', true);
                 return;
            }

            console.log(`【RENEWAL】Initiating renewal request: User=${username}, Amount=${amount}, Option=${optionKey}`);
            setButtonLoading(confirmButton, true, '处理中...');
            showMessage(processMessageArea, '正在创建续费订单...', false);
            clearPaymentArea('#renewal-section .qrcode-container', '#renewal-section .payment-info', '#renewal-section #redirect-renewal-pay'); // Clear renewal QR area

            try {
                // Determine the correct endpoint. Assuming a dedicated one for renewal needing auth.
                // If using /api/create_payment, it needs to handle renewal logic based on auth.
                const apiEndpoint = `${BACKEND_BASE_URL}/api/create_renewal_payment`; // Or potentially /api/create_payment
                console.log(`【RENEWAL】Calling API: ${apiEndpoint}`);

                 const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${token}` // Renewal requires authentication
                     },
                    // Send only necessary data for renewal
                    body: JSON.stringify({ username: username, amount: amount, option_key: optionKey })
                });

                 // --- Handle response (similar structure to registration) ---
                 if (response.status === 202) { // Async task accepted
                     const data = await response.json();
                     if (data.status === 'processing' && data.out_trade_no) {
                         console.log(`【RENEWAL ASYNC】Backend accepted task, Order ID: ${data.out_trade_no}`);
                         showMessage(processMessageArea, '续费订单创建中...', false);
                         // Start task polling using renewal selectors
                         startPaymentTaskPolling(
                             data.out_trade_no,
                             processMessageArea, // Renewal message area
                             username,
                             confirmButton, // Renewal confirm button
                             '#renewal-section .qrcode-container', // Renewal QR container
                             '#renewal-section .payment-info',    // Renewal payment info
                             '#renewal-section #redirect-renewal-pay' // Renewal redirect button (adjust ID if needed)
                         );
                     } else {
                         throw new Error('后端响应格式不正确 (status: processing, out_trade_no)。');
                     }
                 } else if (response.ok) { // Sync success?
                     const data = await response.json();
                     console.warn("【RENEWAL SYNC】Backend returned success directly:", data);
                     stopPaymentTaskPolling('收到同步成功响应');
                     // setButtonLoading(confirmButton, false); // handlePaymentInfo will manage
                     if (data.out_trade_no && (data.pay_url || data.qr_code_url)) {
                          handlePaymentInfo(
                              data,
                              processMessageArea,
                              username,
                              confirmButton,
                             '#renewal-section .qrcode-container',
                             '#renewal-section .payment-info',
                             '#renewal-section #redirect-renewal-pay'
                          );
                     } else {
                          throw new Error('续费成功响应缺少支付信息 (out_trade_no, pay_url/qr_code_url)。');
                     }
                 } else { // Handle errors
                     const errorData = await response.json().catch(() => ({ message: '无法解析错误信息' }));
                      if (response.status === 401 || response.status === 403) {
                         console.warn(`【RENEWAL】Auth failed (${response.status}). Logging out.`);
                         logout(); // Token invalid or unauthorized, logout
                         showMessage(processMessageArea || document.body, '认证失败，请重新登录。', true);
                     } else {
                         throw new Error(errorData.message || `续费请求失败 (${response.status})`);
                     }
                 }
            } catch (error) {
                console.error('【RENEWAL】Error during renewal request:', error);
                showMessage(processMessageArea, `续费失败: ${error.message}`, true);
                setButtonLoading(confirmButton, false);
                stopPaymentTaskPolling('续费请求出错'); // Stop task polling on error
            }
        }

        // Stop renewal task polling (uses the generic stop function)
        function stopRenewalTaskPolling(reason) {
             console.log(`【RENEWAL TASK POLL】Stopping (using generic stop): ${reason}`);
             stopPaymentTaskPolling(reason); // Call the common task polling stop function
        }

        // --- 密码重置 ---
        async function handleRequestResetToken(username) {
            const step1Message = document.getElementById('reset-step1-message');
            const requestButton = document.getElementById('request-reset-token-btn');
            console.log(`【RESET】Requesting password reset token for ${username}`);
            setButtonLoading(requestButton, true, '请求中...');
            showMessage(step1Message, '正在向服务器发送请求...', false);

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/request_password_reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json(); // Expect JSON response
                if (response.ok) {
                    console.log(`【RESET】Token request successful for ${username}. Token: ${data.reset_token}`); // Log token
                    resetUsername = username; // Store username

                    // --- 修改: 在消息中显示令牌 ---
                    const successMessage = `${data.message || '重置令牌已发送/生成，请复制下方令牌并继续。'} \n\n令牌 (请手动复制并粘贴到下方输入框):\n${data.reset_token}`;
                    
                    // --- 新增: 自动填充令牌 --- 
                    const resetTokenInput = document.getElementById('reset-token');
                    if (resetTokenInput) {
                        resetTokenInput.value = data.reset_token;
                        console.log("【RESET】Autofilled reset token input.");
                    } else {
                        console.warn("【RESET】Could not find reset-token input element to autofill.");
                    }
                    // --- 结束新增 --- 

                    showMessage(step1Message, successMessage, false, true);
                    // 可以考虑让令牌部分加粗或高亮，但纯文本也能工作
                    step1Message.style.whiteSpace = 'pre-wrap'; // Ensure newline is respected
                    // --- 结束修改 ---

                    // Show step 2, hide step 1
                    document.getElementById('reset-step-1').style.display = 'none';
                    document.getElementById('reset-step-2').style.display = 'block';
                    document.getElementById('reset-step2-message').style.display = 'none'; // Clear step 2 message area
                    setButtonLoading(document.getElementById('submit-reset-password-btn'), false); // Ensure step 2 button is ready

                } else {
                    console.error(`【RESET】Token request failed for ${username} (${response.status}):`, data.message);
                    showMessage(step1Message, data.message || `请求令牌失败 (${response.status})`, true);
                }
            } catch (error) {
                console.error('【RESET】Network error requesting reset token:', error);
                showMessage(step1Message, '请求重置令牌时发生网络错误。', true);
            } finally {
                setButtonLoading(requestButton, false);
            }
        }

        async function handleSubmitResetPassword(token, newPassword) {
            const step2Message = document.getElementById('reset-step2-message');
            const submitButton = document.getElementById('submit-reset-password-btn');

            if (!resetUsername) { // Ensure username was stored from step 1
                showMessage(step2Message, '无法获取用户名，请返回上一步重试。', true);
                // Optionally switch back to step 1 UI
                document.getElementById('reset-step-1').style.display = 'block';
                document.getElementById('reset-step-2').style.display = 'none';
                return;
            }

            console.log(`【RESET】Attempting to reset password for ${resetUsername}`);
            setButtonLoading(submitButton, true, '重置中...');
            showMessage(step2Message, '正在提交新密码...', false);

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/reset_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: resetUsername, token, new_password: newPassword })
                });
                const data = await response.json(); // Expect JSON response

                if (response.ok) {
                    console.log(`【RESET】Password reset successful for ${resetUsername}`);
                    // Show success step (step 3)
                    document.getElementById('reset-step-2').style.display = 'none';
                    document.getElementById('reset-step-3').style.display = 'block';
                    document.getElementById('reset-final-message').textContent = data.message || '密码重置成功！请使用新密码登录。';
                    resetUsername = ''; // Clear temporary username

                } else {
                    console.error(`【RESET】Password reset failed for ${resetUsername} (${response.status}):`, data.message);
                    showMessage(step2Message, data.message || `密码重置失败 (${response.status})`, true);
                }
            } catch (error) {
                console.error('【RESET】Network error resetting password:', error);
                showMessage(step2Message, '重置密码时发生网络错误。', true);
            } finally {
                setButtonLoading(submitButton, false);
            }
        }

        // --- Other Helper Functions ---
        // Copy URL to Clipboard
        function copyUrlToClipboard(url) {
            if (!navigator.clipboard) {
                 alert('您的浏览器不支持自动复制，请手动复制。');
                 return;
            }
            navigator.clipboard.writeText(url).then(() => {
                console.log("【CLIPBOARD】URL copied:", url);
                const copyBtn = document.getElementById('copy-zlib-url');
                 if (copyBtn) {
                     const originalText = copyBtn.textContent;
                     copyBtn.textContent = '已复制!';
                     setButtonLoading(copyBtn, true); // Briefly disable
                     setTimeout(() => {
                          copyBtn.textContent = originalText;
                          setButtonLoading(copyBtn, false);
                     }, 1500);
                 }
            }).catch(err => {
                console.error('【CLIPBOARD】Failed to copy URL: ', err);
                alert('复制失败，请手动复制。');
            });
        }

        // Show Access Warning Dialog
        function showWarnDialog(url) {
            const dialog = document.getElementById('warn-dialog');
            const confirmBtn = document.getElementById('confirm-jump');
            const cancelBtn = document.getElementById('cancel-jump');

            if (!dialog || !confirmBtn || !cancelBtn) {
                console.error("【WARN DIALOG】Dialog elements not found. Opening URL directly.");
                window.open(url, '_blank', 'noopener noreferrer');
                return;
            }

            // Clone and replace buttons to remove old listeners reliably
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            // Add new listeners
            newConfirmBtn.onclick = () => {
                console.log("【WARN DIALOG】User confirmed jump to:", url);
                dialog.style.display = 'none';
                window.open(url, '_blank', 'noopener noreferrer');
            };
            newCancelBtn.onclick = () => {
                console.log("【WARN DIALOG】User cancelled jump.");
                dialog.style.display = 'none';
            };

            dialog.style.display = 'flex'; // Show dialog using flex for centering
        }

         // Detect iOS and show warning banner
         function checkAndShowIOSWarning() {
             const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
             const warningBanner = document.getElementById('ios-warning');
             const closeButton = warningBanner ? warningBanner.querySelector('.close-warning') : null;

             if (isIOS && warningBanner) {
                 console.log("【PLATFORM】iOS detected. Showing warning banner.");
                 warningBanner.style.display = 'block';
                 if (closeButton) {
                     // Ensure listener isn't added multiple times if this runs again
                     if (!closeButton.hasAttribute('data-listener-added')) {
                          closeButton.onclick = () => {
                              warningBanner.style.display = 'none';
                              console.log("【PLATFORM】iOS warning banner closed by user.");
                          };
                          closeButton.setAttribute('data-listener-added', 'true');
                     }
                 } else { console.warn("【PLATFORM】iOS warning banner close button not found."); }
             } else if (warningBanner) {
                  warningBanner.style.display = 'none';
             }
         }

        // --- 新增: 提前定义 checkPendingPaymentOnLoad ---
        // 页面加载时检查是否有待处理的支付 (现在也检查注册)
        function checkPendingPaymentOnLoad(currentUsername) {
             // 先检查是否有待处理的注册支付
             const pendingRegData = localStorage.getItem('pendingRegistrationPayment');
             if (pendingRegData) {
                 console.log("【REGISTER STATE】Found pending registration data on load:", pendingRegData);
                 // 如果找到待处理注册，则由 DOMContentLoaded 中的恢复逻辑处理
                 // 这里不需要再做什么，因为 DOMContentLoaded 会优先处理它
                 return true; // 返回 true 表示有待处理注册
             }

             // 如果没有待处理注册，再检查是否有旧的待处理支付 (可能用于续费或其他)
             const pendingPaymentData = localStorage.getItem('pendingZlibPayment');
             if (pendingPaymentData) {
                 console.log("【PENDING PAYMENT】Found generic pending payment data in localStorage:", pendingPaymentData);
                 let pendingInfo;
                 try {
                     pendingInfo = JSON.parse(pendingPaymentData);
                 } catch (e) {
                     console.error("【PENDING PAYMENT】Error parsing pending payment data. Clearing.", e);
                     localStorage.removeItem('pendingZlibPayment');
                     return false;
                 }

                 // Validate data and check if it matches the current user (if logged in)
                 if (pendingInfo.out_trade_no && pendingInfo.username &&
                     (!currentUsername || pendingInfo.username === currentUsername)) {

                     console.log(`【PENDING PAYMENT】Resuming generic payment status polling for Order ID: ${pendingInfo.out_trade_no}, User: ${pendingInfo.username}.`);

                     // Show polling status indicator
                     const pollingStatusDiv = document.getElementById('payment-polling-status');
                     if (pollingStatusDiv) {
                          pollingStatusDiv.innerHTML = `<p class=\"pulse\">检测到上次未完成的支付，正在恢复查询...</p>`;
                          pollingStatusDiv.style.display = 'block';
                          // We are likely on the dashboard here, so this message should appear
                     } else {
                          console.warn("【PENDING PAYMENT】Polling status div not found, cannot display recovery message.");
                     }

                     // Stop any potential lingering task polling
                     stopPaymentTaskPolling("Resuming generic payment poll from pending data");
                     // Start the payment status poll
                     startPaymentPolling(pendingInfo.out_trade_no, pendingInfo.username);
                     return true; // 返回 true 表示有待处理支付

                 } else if (pendingInfo.out_trade_no && currentUsername && pendingInfo.username !== currentUsername) {
                     console.warn(`【PENDING PAYMENT】Pending payment belongs to different user (${pendingInfo.username}). Clearing.`);
                     localStorage.removeItem('pendingZlibPayment');
                 } else {
                      console.warn("【PENDING PAYMENT】Invalid or incomplete generic pending payment data found. Clearing.", pendingInfo);
                      localStorage.removeItem('pendingZlibPayment');
                 }
             } else {
                  console.log("【PENDING PAYMENT】No generic pending payment found in localStorage.");
             }
             return false; // 返回 false 表示没有找到待处理支付
         }
         // --- 结束新增 ---

        // --- DOMContentLoaded Event Listener (修复结构) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("【DOM】DOM fully loaded and parsed.");

            // ... (获取元素的代码保持不变) ...
            const welcomeSection = document.getElementById('welcome-section');
            const loginFormSection = document.getElementById('login-form');
            const registerFormSection = document.getElementById('register-form');
            const userDashboardSection = document.getElementById('user-dashboard');
            const passwordResetSection = document.getElementById('password-reset-form');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const loginFormElement = document.getElementById('login-form-element');
            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginMessage = document.getElementById('login-message');
            const backToWelcomeFromLoginBtn = document.getElementById('back-to-welcome-from-login');
            const showForgotPasswordLink = document.getElementById('show-forgot-password-link');
            const registerFormElement = document.getElementById('register-form-element'); 
            const registerUsernameInput = document.getElementById('register-username');
            const registerPasswordInput = document.getElementById('register-password');
            const registerXhsOrderIdInput = document.getElementById('register-xhs-order-id');
            const submitRegisterBtn = document.getElementById('submit-register-btn');
            const registerMessage = document.getElementById('register-message');
            const backToWelcomeFromRegisterBtn = document.getElementById('back-to-welcome-from-register');
            const logoutBtn = document.getElementById('logout-btn'); 
            const getUrlBtn = document.getElementById('get-url-btn');
            const resetStep1Div = document.getElementById('reset-step-1');
            const resetStep2Div = document.getElementById('reset-step-2');
            const resetStep3Div = document.getElementById('reset-step-3');
            const resetUsernameInput = document.getElementById('reset-username');
            const requestResetTokenBtn = document.getElementById('request-reset-token-btn');
            const resetStep1Message = document.getElementById('reset-step1-message');
            const resetTokenInput = document.getElementById('reset-token');
            const resetNewPasswordInput = document.getElementById('reset-new-password');
            const submitResetPasswordBtn = document.getElementById('submit-reset-password-btn');
            const resetStep2Message = document.getElementById('reset-step2-message');
            const backToLoginFromResetBtn = document.getElementById('back-to-login-from-reset');
            const cancelResetBtn = document.getElementById('cancel-reset-btn');
            const warnDialog = document.getElementById('warn-dialog');
            const confirmJumpBtn = document.getElementById('confirm-jump');
            const cancelJumpBtn = document.getElementById('cancel-jump');

            // --- Initial Setup ---
            console.log("【DOM】Running initial setup...");
            checkAndShowIOSWarning(); 
            checkUserStatus();
            console.log("【DOM】Initial setup complete.");

            // --- Event Listeners --- 
            console.log("【DOM】Attaching event listeners...");

            // Welcome Buttons
            if (showLoginBtn) showLoginBtn.addEventListener('click', () => showSection('login-form'));
            else console.warn("Element not found: show-login-btn");
            if (showRegisterBtn) showRegisterBtn.addEventListener('click', () => showSection('register-form'));
            else console.warn("Element not found: show-register-btn");

            // Login Form (修复 try...catch 结构)
            if (loginFormElement) {
                loginFormElement.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = loginUsernameInput.value.trim();
                    const password = loginPasswordInput.value.trim();
                    const loginButton = loginFormElement.querySelector('button[type="submit"]');

                    if (!username || !password) {
                        showMessage(loginMessage, '请输入用户名和密码。', true);
                        return;
                    }
                    console.log(`【LOGIN】Attempting login for user: ${username}`);
                    setButtonLoading(loginButton, true, '登录中...');
                    showMessage(loginMessage, '正在登录...', false);
                    try {
                        const response = await fetch(`${BACKEND_BASE_URL}/api/login`, {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ username, password })
                         });
                        // --- 修复：确保 response.json() 也在 try 块内处理 --- 
                        const data = await response.json(); // 尝试解析

                        if (response.ok && data.token) {
                            localStorage.setItem(JWT_TOKEN_KEY, data.token);
                            localStorage.setItem('zlibUsername', username);
                            showMessage(loginMessage, '登录成功！正在加载用户信息...', false, true);
                            localStorage.removeItem('pendingZlibPayment');
                            setTimeout(checkUserStatus, 500);
                        } else {
                            console.error(`【LOGIN】Login failed (${response.status}):`, data);
                            showMessage(loginMessage, data.message || `登录失败 (${response.status})`, true);
                            setButtonLoading(loginButton, false); // 只在失败时恢复按钮
                        }
                    // --- 修复：添加 catch 块 --- 
                    } catch (error) { 
                        console.error('【LOGIN】Network or parsing error during login:', error);
                        showMessage(loginMessage, '登录过程中发生错误，请检查网络或稍后重试。', true);
                        setButtonLoading(loginButton, false); // 网络错误也要恢复按钮
                    } // <--- 确保 catch 块结束
                }); // <--- 确保事件监听器结束
            } else console.warn("Element not found: login-form-element");

            // Back button from Login
            if (backToWelcomeFromLoginBtn) backToWelcomeFromLoginBtn.addEventListener('click', () => showSection('welcome-section'));
            else console.warn("Element not found: back-to-welcome-from-login");

            // Forgot Password Link
            if (showForgotPasswordLink) { 
                showForgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("【RESET】Showing password reset form.");
                    // ... (重置表单状态的代码保持不变)
                    if(resetStep1Div) resetStep1Div.style.display = 'block';
                    if(resetStep2Div) resetStep2Div.style.display = 'none';
                    if(resetStep3Div) resetStep3Div.style.display = 'none';
                    if(resetUsernameInput) resetUsernameInput.value = '';
                    if(resetTokenInput) resetTokenInput.value = '';
                    if(resetNewPasswordInput) resetNewPasswordInput.value = '';
                    if(resetStep1Message) resetStep1Message.style.display = 'none';
                    if(resetStep2Message) resetStep2Message.style.display = 'none';
                    if(requestResetTokenBtn) setButtonLoading(requestResetTokenBtn, false);
                    if(submitResetPasswordBtn) setButtonLoading(submitResetPasswordBtn, false);
                    showSection('password-reset-form');
                });
            } else console.warn("Element not found: show-forgot-password-link");

            // Register Button
            if (submitRegisterBtn) {
                submitRegisterBtn.addEventListener('click', handleRegistration);
            } else console.warn("Element not found: submit-register-btn");

            // Back button from Register
            if (backToWelcomeFromRegisterBtn) backToWelcomeFromRegisterBtn.addEventListener('click', () => showSection('welcome-section'));
            else console.warn("Element not found: back-to-welcome-from-register");

            // Logout Button
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            else console.warn("Element not found: logout-btn (dashboard)");

            // Refresh URL Button
            if (getUrlBtn) {
                getUrlBtn.addEventListener('click', () => {
                     console.log("【URL】User clicked refresh button.");
                     checkUserStatus('manual_refresh');
                });
            } else console.warn("Element not found: get-url-btn");

            // Password Reset Buttons
            if (requestResetTokenBtn) { 
                 requestResetTokenBtn.addEventListener('click', () => {
                     const username = resetUsernameInput.value.trim();
                     if (!username) {
                         showMessage(resetStep1Message, '请输入用户名。', true);
                         return;
                     }
                     handleRequestResetToken(username);
                 });
            } else console.warn("Element not found: request-reset-token-btn");

            if (submitResetPasswordBtn) { 
                 submitResetPasswordBtn.addEventListener('click', () => {
                     const token = resetTokenInput.value.trim();
                     const newPassword = resetNewPasswordInput.value.trim();
                     if (!token || !newPassword) {
                         showMessage(resetStep2Message, '请输入令牌和新密码。', true);
                         return;
                     }
                     if (newPassword.length < 8) {
                         showMessage(resetStep2Message, '新密码长度不能少于8位。', true);
                         return;
                     }
                     handleSubmitResetPassword(token, newPassword);
                 });
            } else console.warn("Element not found: submit-reset-password-btn");

            if (backToLoginFromResetBtn) backToLoginFromResetBtn.addEventListener('click', () => showSection('login-form'));
            else console.warn("Element not found: back-to-login-from-reset");

            if (cancelResetBtn) cancelResetBtn.addEventListener('click', () => showSection('login-form'));
            else console.warn("Element not found: cancel-reset-btn");

            // Warn Dialog Buttons (Listeners added dynamically)
            if (!confirmJumpBtn) console.warn("Element not found: confirm-jump");
            if (!cancelJumpBtn) console.warn("Element not found: cancel-jump");

            console.log("【DOM】Event listeners attached.");

        }); // End of DOMContentLoaded

        // --- 修改注册逻辑 --- 
        async function handleRegistration() {
            const usernameInput = document.getElementById('register-username');
            const passwordInput = document.getElementById('register-password');
            const xhsOrderIdInput = document.getElementById('register-xhs-order-id'); // 获取新输入框
            const registerMessage = document.getElementById('register-message');
            const registerButton = document.getElementById('submit-register-btn');

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const xiaohongshuOrderId = xhsOrderIdInput.value.trim(); // 获取订单号
            const log_prefix = `【注册 - ${username}】`;

            // --- 输入验证 --- 
            if (!username || !password || !xiaohongshuOrderId) {
                showMessage(registerMessage, '用户名、密码和小红书订单号均不能为空。', true);
                return;
            }
            if (password.length < 8) { 
                showMessage(registerMessage, '密码长度不能少于8位。', true);
                return;
            }

            console.log(`${log_prefix} 开始注册流程 (订单号: ${xiaohongshuOrderId})`);
            setButtonLoading(registerButton, true, '注册中...');
            showMessage(registerMessage, '正在提交注册信息...', false);

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        xiaohongshu_order_id: xiaohongshuOrderId // 发送新字段
                    })
                });

                const data = await response.json().catch(() => ({ message: '无法解析服务器响应' })); // 尝试解析，即使失败

                if (response.status === 201) { // Created
                    console.log(`${log_prefix} 注册成功`);
                    showMessage(registerMessage, data.message || '注册成功！即将跳转到登录页面...', false, true);
                    // 清空表单
                    usernameInput.value = '';
                    passwordInput.value = '';
                    xhsOrderIdInput.value = '';
                    // 延迟跳转到登录
                    setTimeout(() => {
                        showSection('login-form');
                        // 清理注册消息
                        if(registerMessage) registerMessage.style.display = 'none'; 
                    }, 2000);
                } else {
                    // 处理错误 (用户名已存在 409, 输入无效 400, 服务器错误 500)
                    console.error(`${log_prefix} 注册失败 (${response.status}):`, data.message);
                    showMessage(registerMessage, data.message || `注册失败 (${response.status})，请检查输入或稍后重试。`, true);
                }

            } catch (error) {
                console.error(`${log_prefix} 注册时发生网络错误:`, error);
                showMessage(registerMessage, '注册过程中发生网络错误，请检查您的网络连接并重试。', true);
            } finally {
                setButtonLoading(registerButton, false); // 无论成功失败都恢复按钮
            }
        }
        // --- 结束修改注册逻辑 ---

    </script>
    <script type="text/javascript" src="//js.users.51.la/21956139.js"></script>
</body>
</html>
            
